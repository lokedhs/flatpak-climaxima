{
    "app-id": "com.dhsdevelopments.Climaxima",
    "runtime": "org.gnome.Platform",
    "runtime-version": "3.30",
    "sdk": "org.gnome.Sdk",
    "command": "clim-maxima",
    "modules": [
        {
            "name": "sbcl",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "archive",
                    "url": "http://prdownloads.sourceforge.net/sbcl/sbcl-1.5.3-x86-64-linux-binary.tar.bz2",
                    "sha256": "6fbd04e6fc81bc3b755372ba02410bc52466301b571337ff0a5f2b0ede6d76dc"
                }
            ],
            "build-options": {
                "env": {
                    "BUILD_ROOT": "/app/sbcl"
                }
            },
            "build-commands": [
                "sh install.sh"
            ]
        },
        {
            "name": "mcclim",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/McCLIM/McCLIM",
                    "commit": "e0dafe84596a156d410dbed1254d3a038442921b"
                },
                {
                    "type": "file",
                    "path": "quicklisp.lisp"
                },
                {
                    "type": "file",
                    "path": "sbclrc"
                }
            ],
            "build-options": {
                "env": {
                    "SBCL_HOME": "/app/sbcl/usr/local/lib/sbcl"
                },
                "build-args": [
                    "--share=network"
                ]
            },
            "build-commands": [
                "/app/sbcl/usr/local/bin/sbcl --load quicklisp.lisp --quit --eval '(quicklisp-quickstart:install :path \"/app/quicklisp/\")'",
                "mkdir /app/tools",
                "cp sbclrc /app/tools/sbcl-init.lisp",
                "cp -ar . /app/McCLIM",
                "ln -s /app/McCLIM /app/quicklisp/local-projects",
                "sed -i 's/\"libfontconfig\\.so\"/(:or \"libfontconfig\\.so\\.1\" \"libfontconfig\\.so\")/' /app/McCLIM/Extensions/fontconfig/src/functions.lisp",
                "sed -i 's/\"libharfbuzz\\.so\"/(:or \"libharfbuzz\\.so\\.0\" \"libharfbuzz\\.so\")/' /app/McCLIM/Extensions/harfbuzz/src/functions.lisp"
            ]
        },
        {
            "name": "cl-freetype2",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/lokedhs/cl-freetype2",
                    "commit": "fe9d8108154cb4f4e46622bcaea4ba6155a3b5af"
                }
            ],
            "build-commands": [
                "cp -ar . /app/cl-freetype2",
                "ln -s /app/cl-freetype2 /app/quicklisp/local-projects"
            ]
        },
        {
            "name": "maxima-code",
            "sources": [
                {
                    "type": "git",
                    "url": "https://git.code.sf.net/p/maxima/code",
                    "commit": "0721ffcd43de13fd288362373edc9681929abed9"
                }
            ],
            "build-options": {
                "env": {
                    "SBCL_HOME": "/app/sbcl/usr/local/lib/sbcl"
                }
            },
            "config-opts": [ "--enable-sbcl", "--with-sbcl=/app/sbcl/usr/local/bin/sbcl" ],
            "build-commands": [ "cp -ar . /app/maxima-code",
                                "ln -s /app/maxima-code /app/quicklisp/local-projects/maxima-code" ]
        },
        {
            "name": "climaxima",
            "buildsystem": "simple",
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/lokedhs/maxima-client",
                    "commit": "3c198d28f5b036a7b584387a2e2480869026a664"
                },
                {
                    "type": "file",
                    "path": "startup.lisp"
                }
            ],
            "build-options": {
                "env": {
                    "SBCL_HOME": "/app/sbcl/usr/local/lib/sbcl"
                },
                "build-args": [
                    "--share=network"
                ]
            },
            "build-commands": [
                "cp -ar . /app/maxima-client",
                "ln -s /app/maxima-client /app/quicklisp/local-projects/maxima-client",
                "cd /app/maxima-client && /app/sbcl/usr/local/bin/sbcl --load /app/tools/sbcl-init.lisp --load startup.lisp",
                "cd /app/maxima-client/infoparser && /app/sbcl/usr/local/bin/sbcl --load /app/tools/sbcl-init.lisp --non-interactive --disable-debugger --eval '(ql:quickload \"infoparser\")' --eval '(sb-ext:save-lisp-and-die \"maxima-parser.bin\" :toplevel #'\"'\"'infoparser::resolve-example-code-external :executable t)'",
                "mkdir -p /app/bin",
                "ln -s /app/maxima-client/clim-maxima /app/bin/clim-maxima",
                "/app/sbcl/usr/local/bin/sbcl --load /app/tools/sbcl-init.lisp --non-interactive --disable-debugger --eval '(ql:quickload \"infoparser\")' --eval '(infoparser:generate-doc-directory :skip-example t :skip-figures t)'"
            ]
        },
        {
            "name": "desktop-integration",
            "buildsystem": "simple",
            "sources": [ { "type": "file", "path": "com.dhsdevelopments.Climaxima.appdata.xml" },
                         { "type": "file", "path": "com.dhsdevelopments.Climaxima.desktop" } ],
            "build-commands": [
                "mkdir -p /app/share/metainfo",
                "cp com.dhsdevelopments.Climaxima.appdata.xml /app/share/metainfo/com.dhsdevelopments.Climaxima.appdata.xml",
                "mkdir -p /app/share/applications",
                "cp com.dhsdevelopments.Climaxima.desktop /app/share/applications/com.dhsdevelopments.Climaxima.desktop"
            ]
        }
    ],
    "finish-args": [
        "--socket=x11",
        "--share=network"
    ]
}
